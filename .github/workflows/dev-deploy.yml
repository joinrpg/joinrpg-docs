name: Build and deploy dev docs

on:
  push:
    branches-ignore:
      - "master"
    tags-ignore:
      - "*"
  workflow_dispatch:

jobs:
  build:
    name: Build Sphinx docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0

      - name: Set Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r docs/requirements.txt

      - name: Build static files
        run: |
          cd docs
          make html-all 2>&1 | tee build.log
          
          # Parse warnings and errors and create GitHub annotations
          if grep -E "(WARNING|ERROR|CRITICAL)" build.log > /dev/null; then
            echo "::group::Build Warnings and Errors"
            while IFS= read -r line; do
              # Match Sphinx warning/error format: file.rst:123: WARNING: message
              if echo "$line" | grep -qE "\.(rst|md):[0-9]+: (WARNING|ERROR|CRITICAL)"; then
                file=$(echo "$line" | sed -E 's|^([^:]+):[0-9]+:.*|\1|')
                line_num=$(echo "$line" | sed -E 's|^[^:]+:([0-9]+):.*|\1|')
                message=$(echo "$line" | sed -E 's|^[^:]+:[0-9]+: (WARNING|ERROR|CRITICAL): ||')
                
                # Make path relative to repo root (we're in docs/ directory)
                if [[ "$file" != /* ]]; then
                  # Already relative, ensure it's from repo root
                  file="docs/$file"
                else
                  # Absolute path, convert to relative
                  file=$(realpath --relative-to="$GITHUB_WORKSPACE" "$file" 2>/dev/null || echo "$file")
                fi
                
                if echo "$line" | grep -qE "ERROR|CRITICAL"; then
                  echo "::error file=$file,line=$line_num::$message"
                else
                  echo "::warning file=$file,line=$line_num::$message"
                fi
              fi
            done < build.log
            echo "::endgroup::"
          fi
          
          # Show summary
          echo "::notice::Build completed. Check the log above for details."

      - name: Upload build artifact
        uses: actions/upload-artifact@v5.0.0
        with:
          name: docs-html
          path: docs/_build/html

  deploy:
    name: Deploy to docs.dev.joinrpg.ru S3
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download built HTML
        uses: actions/download-artifact@v6.0.0
        with:
          name: docs-html
          path: build_html

      - name: Set up S3cmd cli tool
        uses: s3-actions/s3cmd@v2.0.1
        with:
            provider: yandex
            region: ru-central1
            access_key: ${{ secrets.SYNC_ACCESS_ID }}
            secret_key: ${{ secrets.SYNC_ACCESS_SECRET }}

      - name: sync to s3
        run: |
          cd build_html
          s3cmd sync --recursive --exclude "*.css" --exclude "*.js" * s3://docs.dev.joinrpg.ru
          s3cmd sync --recursive --include "*.css" * --mime-type="text/css" s3://docs.dev.joinrpg.ru
          s3cmd sync --recursive --include "*.js" * --mime-type="application/javascript" s3://docs.dev.joinrpg.ru
